{% extends "base.html" %}

{% block title %}Orçamentos - Finanças Pessoais{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Orçamentos</h5>
        <div>
            <a href="{{ url_for('orcamento.previsao') }}" class="btn btn-info me-2">
                <i class="fas fa-chart-line me-2"></i>Previsão Orçamentária
            </a>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalOrcamento">
                <i class="fas fa-plus me-2"></i>Novo Orçamento
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Cards de Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Orçamento Receitas</h6>
                        <h4 class="card-title mb-0">R$ {{ "{:,.2f}".format(stats.orcamento_receitas) }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Orçamento Despesas</h6>
                        <h4 class="card-title mb-0">R$ {{ "{:,.2f}".format(stats.orcamento_despesas) }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Total Recebido</h6>
                        <h4 class="card-title mb-0">R$ {{ "{:,.2f}".format(stats.total_recebido) }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Total Gasto</h6>
                        <h4 class="card-title mb-0">R$ {{ "{:,.2f}".format(stats.total_gasto) }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Gastos no Limite</h6>
                        <h4 class="card-title mb-0">{{ stats.categorias_limite }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Economia Potencial</h6>
                        <h4 class="card-title mb-0">R$ {{ "{:,.2f}".format(stats.economia_potencial) }}</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <form id="filtroForm" class="row g-3">
                    <div class="col-md-4">
                        <label for="data_inicio_filtro" class="form-label">Data Início</label>
                        <input type="date" class="form-control" id="data_inicio_filtro" name="data_inicio_filtro">
                    </div>
                    <div class="col-md-4">
                        <label for="data_fim_filtro" class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="data_fim_filtro" name="data_fim_filtro">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Filtrar</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="limparFiltros()">Limpar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de Orçamentos -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th>Tipo</th>
                        <th>Valor Orçado</th>
                        <th>Valor Realizado</th>
                        <th>Valor Restante</th>
                        <th>% Realizado</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for orcamento in orcamentos %}
                    <tr>
                        <td>{{ orcamento.categoria }}</td>
                        <td>{{ orcamento.tipo }}</td>
                        <td class="text-end">R$ {{ "{:,.2f}".format(orcamento.valor_orcado) }}</td>
                        <td class="text-end">R$ {{ "{:,.2f}".format(orcamento.valor_realizado) }}</td>
                        <td class="text-end">R$ {{ "{:,.2f}".format(orcamento.valor_restante) }}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar {% if orcamento.percentual >= 90 %}bg-danger{% elif orcamento.percentual >= 75 %}bg-warning{% else %}bg-success{% endif %}"
                                     role="progressbar"
                                     style="width: {{ orcamento.percentual }}%"
                                     aria-valuenow="{{ orcamento.percentual }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">{{ orcamento.percentual }}%</div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editarOrcamento({{ orcamento.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="excluirOrcamento({{ orcamento.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Cadastro/Edição -->
<div class="modal fade" id="modalOrcamento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Orçamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formOrcamento">
                    <input type="hidden" id="orcamento_id" name="id">
                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo</label>
                        <select class="form-select" id="tipo" name="tipo" required>
                            <option value="">Selecione...</option>
                            <option value="Receita">Receita</option>
                            <option value="Despesa">Despesa</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="categoria" class="form-label">Categoria</label>
                        <select class="form-select" id="categoria" name="categoria" required>
                            <option value="">Selecione...</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_inicio" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="data_inicio" name="data_inicio" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_fim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="data_fim" name="data_fim" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção de Lançamentos -->
                    <div class="mb-3">
                        <label class="form-label">Lançamentos</label>
                        <div id="lancamentosContainer">
                            <!-- Os lançamentos serão adicionados aqui dinamicamente -->
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="adicionarLancamento()">
                            <i class="fas fa-plus me-2"></i>Adicionar Lançamento
                        </button>
                    </div>
                    
                    <template id="lancamentoTemplate">
                        <div class="lancamento-item border rounded p-3 mb-2">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Data Inicial</label>
                                    <input type="date" class="form-control lancamento-data-inicial" required>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Recorrência</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <span>Repetir a cada</span>
                                        <input type="number" class="form-control form-control-sm w-auto lancamento-intervalo" 
                                               min="1" value="1" style="width: 70px !important;">
                                        <select class="form-select form-select-sm w-auto lancamento-periodo">
                                            <option value="day">dia</option>
                                            <option value="week">semana</option>
                                            <option value="month">mês</option>
                                            <option value="year">ano</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Opções de dias da semana -->
                                    <div class="mt-2 lancamento-dias-semana">
                                        <div class="btn-group" role="group">
                                            <input type="checkbox" class="btn-check" id="dom-{ID}" name="dias-semana-{ID}" value="0">
                                            <label class="btn btn-outline-primary btn-sm" for="dom-{ID}">D</label>
                                            
                                            <input type="checkbox" class="btn-check" id="seg-{ID}" name="dias-semana-{ID}" value="1">
                                            <label class="btn btn-outline-primary btn-sm" for="seg-{ID}">S</label>
                                            
                                            <input type="checkbox" class="btn-check" id="ter-{ID}" name="dias-semana-{ID}" value="2">
                                            <label class="btn btn-outline-primary btn-sm" for="ter-{ID}">T</label>
                                            
                                            <input type="checkbox" class="btn-check" id="qua-{ID}" name="dias-semana-{ID}" value="3">
                                            <label class="btn btn-outline-primary btn-sm" for="qua-{ID}">Q</label>
                                            
                                            <input type="checkbox" class="btn-check" id="qui-{ID}" name="dias-semana-{ID}" value="4">
                                            <label class="btn btn-outline-primary btn-sm" for="qui-{ID}">Q</label>
                                            
                                            <input type="checkbox" class="btn-check" id="sex-{ID}" name="dias-semana-{ID}" value="5">
                                            <label class="btn btn-outline-primary btn-sm" for="sex-{ID}">S</label>
                                            
                                            <input type="checkbox" class="btn-check" id="sab-{ID}" name="dias-semana-{ID}" value="6">
                                            <label class="btn btn-outline-primary btn-sm" for="sab-{ID}">S</label>
                                        </div>
                                    </div>
                
                                    <!-- Opções de repetição mensal -->
                                    <div class="mt-2 lancamento-repeticao-mensal">
                                        <div class="form-check mb-2">
                                            <input type="radio" class="form-check-input" name="tipo-mes-{ID}" value="dayOfMonth" checked>
                                            <label class="form-check-label">Mensalmente no dia</label>
                                            <div class="mt-1 ms-4">
                                                <select class="form-select form-select-sm w-auto" name="dia-mes-{ID}">
                                                    {% for dia in range(1, 32) %}
                                                    <option value="{{ dia }}">{{ dia }}º dia</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input type="radio" class="form-check-input" name="tipo-mes-{ID}" value="dayOfWeek">
                                            <label class="form-check-label">Mensalmente na</label>
                                            <div class="mt-1 ms-4 d-flex gap-2">
                                                <select class="form-select form-select-sm w-auto" name="semana-mes-{ID}">
                                                    <option value="1">primeira</option>
                                                    <option value="2">segunda</option>
                                                    <option value="3">terceira</option>
                                                    <option value="4">quarta</option>
                                                    <option value="5">última</option>
                                                </select>
                                                <select class="form-select form-select-sm w-auto" name="dia-semana-mes-{ID}">
                                                    <option value="0">domingo</option>
                                                    <option value="1">segunda-feira</option>
                                                    <option value="2">terça-feira</option>
                                                    <option value="3">quarta-feira</option>
                                                    <option value="4">quinta-feira</option>
                                                    <option value="5">sexta-feira</option>
                                                    <option value="6">sábado</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    
                                <div class="col-md-2">
                                    <label class="form-label">Valor</label>
                                    <input type="number" class="form-control lancamento-valor" step="0.01" required>
                                </div>
                    
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removerLancamento(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-12">
                                    <label class="form-label">Descrição</label>
                                    <input type="text" class="form-control lancamento-descricao">
                                </div>
                            </div>
                        </div>
                    </template>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarOrcamento()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Event Listeners para Filtros
document.getElementById('filtroForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const data_inicio = document.getElementById('data_inicio_filtro').value;
    const data_fim = document.getElementById('data_fim_filtro').value;
    
    window.location.href = `/orcamento/?data_inicio=${data_inicio}&data_fim=${data_fim}`;
});

function limparFiltros() {
    document.getElementById('data_inicio_filtro').value = '';
    document.getElementById('data_fim_filtro').value = '';
    window.location.href = '/orcamento/';
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando handlers de orçamento...');
    
    // Preencher filtros com valores da URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('data_inicio')) {
        document.getElementById('data_inicio_filtro').value = urlParams.get('data_inicio');
    }
    if (urlParams.has('data_fim')) {
        document.getElementById('data_fim_filtro').value = urlParams.get('data_fim');
    }
    
    // Configura lançamentos existentes
    document.querySelectorAll('.lancamento-item').forEach(item => {
        configurarRecorrencia(item);
    });
});

// Funções de Manipulação de Lançamentos
function configurarRecorrencia(lancamentoElement) {
    console.log('Configurando recorrência para elemento:', lancamentoElement);
    
    const selectPeriodo = lancamentoElement.querySelector('select.lancamento-periodo');
    const divDiasSemana = lancamentoElement.querySelector('div.lancamento-dias-semana');
    const divRepeticaoMensal = lancamentoElement.querySelector('div.lancamento-repeticao-mensal');
    
    if (!selectPeriodo || !divDiasSemana || !divRepeticaoMensal) {
        console.error('Elementos necessários não encontrados');
        return;
    }

    // Esconde inicialmente
    divDiasSemana.style.display = 'none';
    divRepeticaoMensal.style.display = 'none';
    
    // Configura os radio buttons da repetição mensal
    const radiosRepeticaoMensal = divRepeticaoMensal.querySelectorAll('input[type="radio"]');
    radiosRepeticaoMensal.forEach(radio => {
        radio.addEventListener('change', function() {
            const diaMesDiv = this.closest('.form-check').querySelector('[name^="dia-mes-"]')?.parentElement;
            const diaSemanaDiv = this.closest('.form-check').querySelector('[name^="semana-mes-"]')?.parentElement;
            
            if (diaMesDiv) diaMesDiv.style.display = this.value === 'dayOfMonth' ? 'block' : 'none';
            if (diaSemanaDiv) diaSemanaDiv.style.display = this.value === 'dayOfWeek' ? 'flex' : 'none';
        });
    });
    
    function handlePeriodoChange() {
        console.log('Período mudou para:', this.value);
        
        divDiasSemana.style.display = 'none';
        divRepeticaoMensal.style.display = 'none';
        
        switch(this.value) {
            case 'week':
                console.log('Mostrando opções semanais');
                divDiasSemana.style.display = 'block';
                break;
            case 'month':
                console.log('Mostrando opções mensais');
                divRepeticaoMensal.style.display = 'block';
                // Dispara o evento change no radio selecionado
                const selectedRadio = divRepeticaoMensal.querySelector('input[type="radio"]:checked');
                if (selectedRadio) selectedRadio.dispatchEvent(new Event('change'));
                break;
        }
    }
    
    selectPeriodo.addEventListener('change', handlePeriodoChange);
    selectPeriodo.dispatchEvent(new Event('change'));
}

function adicionarLancamento(dados = null) {
    console.log('Adicionando novo lançamento:', dados);
    
    const template = document.getElementById('lancamentoTemplate');
    const container = document.getElementById('lancamentosContainer');
    
    if (!template || !container) {
        console.error('Template ou container não encontrado');
        return;
    }
    
    // Cria um elemento temporário e clona o conteúdo do template para ele
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(template.content.cloneNode(true));
    
    // Gera ID único
    const lancamentoId = `lancamento-${Date.now()}`;
    
    // Substitui os placeholders {ID} no HTML do elemento temporário
    tempDiv.innerHTML = tempDiv.innerHTML.replace(/{ID}/g, lancamentoId);
    
    // Adiciona o primeiro (e único) filho do elemento temporário ao container
    const newElement = container.appendChild(tempDiv.firstElementChild);
    
    // Configura a recorrência
    configurarRecorrencia(newElement);
    
    // Preenche dados se fornecidos
    if (dados) {
        preencherDadosLancamento(newElement, dados, lancamentoId);
    }
    
    return newElement;
}

function preencherDadosLancamento(element, dados, lancamentoId) {
    if (!element || !dados) return;

    if (dados.data_inicial) {
        const dataInput = element.querySelector('.lancamento-data-inicial');
        if (dataInput) dataInput.value = dados.data_inicial;
    }
    
    if (dados.valor) {
        const valorInput = element.querySelector('.lancamento-valor');
        if (valorInput) valorInput.value = dados.valor;
    }
    
    if (dados.descricao) {
        const descInput = element.querySelector('.lancamento-descricao');
        if (descInput) descInput.value = dados.descricao;
    }
    
    const selectPeriodo = element.querySelector('.lancamento-periodo');
    if (selectPeriodo && dados.tipo_repeticao) {
        selectPeriodo.value = dados.tipo_repeticao;
        selectPeriodo.dispatchEvent(new Event('change'));
        
        if (dados.dias_semana && Array.isArray(dados.dias_semana)) {
            dados.dias_semana.forEach(dia => {
                const checkbox = element.querySelector(`input[value="${dia}"][name="dias-semana-${lancamentoId}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
    }
    
    if (dados.intervalo_repeticao) {
        const intervaloInput = element.querySelector('.lancamento-intervalo');
        if (intervaloInput) intervaloInput.value = dados.intervalo_repeticao;
    }
}

function removerLancamento(button) {
    console.log('Removendo lançamento');
    const lancamentoItem = button.closest('.lancamento-item');
    if (lancamentoItem) {
        lancamentoItem.remove();
    }
}

// Funções de Manipulação de Orçamentos
function editarOrcamento(id) {
    fetch(`/orcamento/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('orcamento_id').value = data.id;
            document.getElementById('tipo').value = data.tipo;
            document.getElementById('categoria').value = data.categoria_id;
            document.getElementById('data_inicio').value = data.data_inicio;
            document.getElementById('data_fim').value = data.data_fim;
            
            document.getElementById('lancamentosContainer').innerHTML = '';
            data.lancamentos.forEach(lancamento => {
                adicionarLancamento(lancamento);
            });
            
            new bootstrap.Modal(document.getElementById('modalOrcamento')).show();
        });
}

async function salvarOrcamento() {
   try {
       console.log('Iniciando salvamento do orçamento...');
       
       const form = document.getElementById('formOrcamento');
       const formData = new FormData(form);

       // Validações básicas
       const tipo = document.getElementById('tipo').value;
       const categoria = document.getElementById('categoria').value;
       if (!tipo || !categoria) {
           alert('Por favor, preencha o tipo e a categoria do orçamento');
           return;
       }

       const lancamentos = [];
       document.querySelectorAll('.lancamento-item').forEach((item, index) => {
           console.log(`Processando lançamento ${index + 1}`);
           
           const dataInicial = item.querySelector('.lancamento-data-inicial').value;
           const valor = parseFloat(item.querySelector('.lancamento-valor').value);
           
           if (!dataInicial || isNaN(valor) || valor <= 0) {
               throw new Error(`Por favor, verifique a data e valor do lançamento ${index + 1}`);
           }

           const lancamento = {
               data_inicial: dataInicial,
               valor: valor,
               descricao: item.querySelector('.lancamento-descricao').value || '',
               intervalo: parseInt(item.querySelector('.lancamento-intervalo').value) || 1,
               periodo: item.querySelector('.lancamento-periodo').value
           };

           switch(lancamento.periodo) {
               case 'week':
                   const diasSemana = Array.from(
                       item.querySelectorAll('input[type="checkbox"]:checked')
                   ).map(cb => parseInt(cb.value));
                   
                   if (diasSemana.length === 0) {
                       throw new Error(`Selecione pelo menos um dia da semana no lançamento ${index + 1}`);
                   }
                   
                   lancamento.dias_semana = diasSemana;
                   break;

               case 'month':
                   const tipoRepeticaoMensal = item.querySelector('input[name^="tipo-mes-"]:checked');
                   if (!tipoRepeticaoMensal) {
                       throw new Error(`Selecione o tipo de repetição mensal no lançamento ${index + 1}`);
                   }

                   lancamento.tipo_repeticao_mensal = tipoRepeticaoMensal.value;
                   
                   if (tipoRepeticaoMensal.value === 'dayOfMonth') {
                       const diaMes = item.querySelector('select[name^="dia-mes-"]');
                       if (!diaMes) {
                           throw new Error(`Selecione o dia do mês no lançamento ${index + 1}`);
                       }
                       lancamento.dia_mes = parseInt(diaMes.value);
                   } else {
                       const semanaMes = item.querySelector('select[name^="semana-mes-"]');
                       const diaSemana = item.querySelector('select[name^="dia-semana-mes-"]');
                       
                       if (!semanaMes || !diaSemana) {
                           throw new Error(`Selecione a semana e o dia no lançamento ${index + 1}`);
                       }
                       
                       lancamento.semana_mes = parseInt(semanaMes.value);
                       lancamento.dia_semana_mes = parseInt(diaSemana.value);
                   }
                   break;
           }

           console.log('Dados do lançamento:', lancamento);
           lancamentos.push(lancamento);
       });

       if (lancamentos.length === 0) {
           throw new Error('Adicione pelo menos um lançamento ao orçamento');
       }

       formData.append('lancamentos', JSON.stringify(lancamentos));

       console.log('Enviando dados para o servidor...');
       const response = await fetch('/orcamento/salvar', {
           method: 'POST',
           body: formData
       });

       const result = await response.json();
       if (result.success) {
           console.log('Orçamento salvo com sucesso');
           window.location.reload();
       } else {
           throw new Error(result.error || 'Erro ao salvar orçamento');
       }
   } catch (error) {
       console.error('Erro ao salvar:', error);
       alert('Erro ao salvar orçamento: ' + error.message);
   }
}

function excluirOrcamento(id) {
    if (confirm('Tem certeza que deseja excluir este orçamento?')) {
        fetch(`/orcamento/${id}/excluir`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao excluir orçamento: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir orçamento');
        });
    }
}
</script>
{% endblock %}